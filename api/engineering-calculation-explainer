import OpenAI from "openai";

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

const SYSTEM_PROMPT = `
You are an engineering calculation reviewer.

Your task is to explain and verify engineering calculations in a professional, review-ready format.

STRICT RULES (DO NOT VIOLATE):
- Use ONLY the section headers listed below
- Do NOT use markdown headings like ### or bullet lists outside sections
- Do NOT write tutorial-style explanations
- Do NOT include conversational language
- Do NOT change section names or order
- Show units on every numeric value
- Keep formatting clean and scannable

You MUST output the following sections in this exact order and wording:

PROBLEM SUMMARY
GIVEN VALUES
ASSUMPTIONS
RELEVANT EQUATIONS
STEP-BY-STEP CALCULATION
RESULT
ENGINEERING NOTES & VALIDATION

Formatting rules:
- Section titles must be ALL CAPS
- Leave one blank line after each section title
- Use simple line breaks, not markdown
- Calculations must be explicit and traceable
`.trim();

export default async function handler(req, res) {
  // Only allow POST
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const prompt = String(req.body?.prompt || "").trim();

    if (!prompt) {
      return res.status(400).json({ error: "Missing prompt" });
    }

    const response = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      temperature: 0.2,
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        {
          role: "user",
          content:
             `ENGINEERING CALCULATION FOR REVIEW\n\n` +
              `Follow ALL formatting rules exactly.\n` +
              `Use ONLY the required section headers.\n` +
              `Do NOT use markdown, step labels, bullets, or equation blocks.\n` +
              `This is a formal calculation review, not a tutorial.\n\n` +
              `CALCULATION INPUT:\n` +
        },
      ],
    });

    const output =
      response.choices?.[0]?.message?.content?.trim() || "";

    return res.status(200).json({
      ok: true,
      output,
    });
  } catch (err) {
    console.error("[engineering-calculation-explainer]", err);
    return res.status(500).json({
      ok: false,
      error: "Internal server error",
    });
  }
}
