import OpenAI from "openai";

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

const SYSTEM_PROMPT = `
You are an engineering calculation reviewer.
Return ONLY JSON that matches the provided schema.
Do not use markdown.
Do not include LaTeX.
Do not include headings like "Step 1".
`.trim();

function renderSections(data) {
  // Helper: normalize arrays/strings into clean line blocks
  const toLines = (v) => {
    if (!v) return "";
    if (Array.isArray(v)) return v.filter(Boolean).join("\n");
    return String(v).trim();
  };

  return [
    "PROBLEM SUMMARY",
    "",
    toLines(data.problem_summary),
    "",
    "GIVEN VALUES",
    "",
    toLines(data.given_values),
    "",
    "ASSUMPTIONS",
    "",
    toLines(data.assumptions),
    "",
    "RELEVANT EQUATIONS",
    "",
    toLines(data.relevant_equations),
    "",
    "STEP-BY-STEP CALCULATION",
    "",
    toLines(data.step_by_step_calculation),
    "",
    "RESULT",
    "",
    toLines(data.result),
    "",
    "ENGINEERING NOTES & VALIDATION",
    "",
    toLines(data.engineering_notes_validation),
  ]
    .join("\n")
    .replace(/\n{3,}/g, "\n\n") // prevent extra blank lines
    .trim();
}

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const prompt = String(req.body?.prompt || "").trim();
    if (!prompt) return res.status(400).json({ error: "Missing prompt" });

    const response = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      temperature: 0.2,
      // ðŸ”’ Force strict JSON output (the key)
      response_format: {
        type: "json_schema",
        json_schema: {
          name: "engineering_calculation_review",
          strict: true,
          schema: {
            type: "object",
            additionalProperties: false,
            properties: {
              problem_summary: { type: "string" },
              given_values: { type: "array", items: { type: "string" } },
              assumptions: { type: "array", items: { type: "string" } },
              relevant_equations: { type: "array", items: { type: "string" } },
              step_by_step_calculation: { type: "array", items: { type: "string" } },
              result: { type: "array", items: { type: "string" } },
              engineering_notes_validation: { type: "array", items: { type: "string" } },
            },
            required: [
              "problem_summary",
              "given_values",
              "assumptions",
              "relevant_equations",
              "step_by_step_calculation",
              "result",
              "engineering_notes_validation",
            ],
          },
        },
      },
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        {
          role: "user",
          content:
            `Create a calculation review for the following input.\n` +
            `Rules:\n` +
            `- Include units on every numeric value\n` +
            `- Keep each list item to one line\n` +
            `- If something is missing, say so in ASSUMPTIONS and continue symbolically\n\n` +
            `INPUT:\n${prompt}`,
        },
      ],
    });

    const content = response.choices?.[0]?.message?.content || "{}";

    let data;
    try {
      data = JSON.parse(content);
    } catch {
      // If something unexpected happens, fall back to raw (rare)
      return res.status(200).json({
        ok: true,
        output: content,
        note: "Model did not return valid JSON.",
      });
    }

    const output = renderSections(data);

    return res.status(200).json({ ok: true, output });
  } catch (err) {
    console.error("[engineering-calculation-explainer]", err);
    return res.status(500).json({ ok: false, error: "Internal server error" });
  }
}
